Public codigoregimen, filainicial, filafinal, semanastr, semanastr2, totalsemanas, _
                edadtr, genero, tipocalculo, diasdiezaños, diasdiferencia, diastv, diasunaño As Integer
Public fechatr, fechatr2, fechaliquidacion As Date
Public regimentr As Boolean
Public promedioibl10, promedioibltv, totalibl10, totalibltv, valorpensiontv, valorpension10, _
        valorfinalpension, valorfinalpensionl797, totalibl1año, promedioibl1año, _
        valorfinalpensionpub, valorfinalpensionaportes As Double
Public porcentajepension, porcentajel797, numerosmmlv, factorpensionl797 As Variant
Public regimenaplicado, mensaje As String

Public Sub PRINCIPAL()
'PROCEDIMIENTO QUE INICIALIZA LAS VARIABLES Y HACE EL LLAMADO A LOS MÓDULOS DEL POROGRAMA
Application.ScreenUpdating = False
codigoregimen = 0
filainicial = 25
filafinal = 0

filafinal = Worksheets("HL").Range("A25").End(xlDown).Row
semanastr = 0
fechainicial = Range("A25")

If fechainicial > 1000000 Then
    ask = MsgBox("No existen datos para calcular", vbCritical, "Dirección de Ahorro Individual y Prima Media")
    End
End If
fechatr = #4/1/1994#
fechatr2 = #7/25/2003#
regimentr = False

fechaliquidacion = Worksheets("HL").Range("H12")

edadtr = 0
genero = 0
totalsemanas = 0
tipocalculo = 0
año = 0
diasdiezaños = 0
promedioibl10 = 0
diasdiferencia = 0
promedioibltv = 0
totalibl10 = 0
diastv = 0
totalibltv = 0
valorpensiontv = 0
valorpension10 = 0
porcentajepension = 0
valorfinalpension = 0
porcentajel797 = 0
numerosmmlv = 0
factorpensionl797 = 0
valorfinalpensionl797 = 0
totalibl1año = 0
diasunaño = 0
promedioibl1año = 0
valorfinalpensionpub = 0
regimenaplicado = " "
semanastr2 = 0
mensage = ""
valorfinalpensionaportes = 0

Call VALIDACIONES
Call CALCULOS
Call REGIMEN
Call LIQUIDACION
Call RESUMEN
Application.ScreenUpdating = True
a = MsgBox("VALOR PENSIÓN:" + Chr(13) + Str(Format(valorfinalpension, "###,###.00")) + Chr(13) + Str(Format(porcentajepension, "0.00")))
End Sub

Sub REGIMEN()
    'PROCEDIMIENTO QUE DETERMINA EL TIPO DE REGIMEN QUE LE APLICA

'DETERMINA SI ES RÉGIMEN DE TRANSICIÓN

edadtr = Worksheets("HL").Cells(16, "B")
genero = Worksheets("HL").Cells(20, "B")


For i = filainicial To filafinal
    'SI ES REGIMEN DE TRANSICIÓN LEY 100
    If fechatr >= Worksheets("HL").Cells(i, "A") And fechatr <= Worksheets("HL").Cells(i, "B") Then

        If fechatr = Worksheets("HL").Cells(i, "B") Then
            semanastr = Worksheets("HL").Cells(i, "E")
            Exit For
        End If ' fin if fechatr = Worksheets("HL").Cells(i, "B") Then


        If fechatr = Worksheets("HL").Cells(i, "A") Then
            semanastr = Worksheets("HL").Cells(i - 1, "E")
            semanastr = semanastr + (1 / 7)
            Exit For
        End If

        If fechatr > Worksheets("HL").Cells(i, "A") And fechatr < Worksheets("HL").Cells(i, "B") Then
            semanastr = Worksheets("HL").Cells(i - 1, "E")
            semanastr = semanastr + (fechatr - Worksheets("HL").Cells(i, "A")) / 7
            Exit For
        End If
    End If 'fin if fechatr >= Worksheets("HL").Cells(i, "A") Or fechatr <= Worksheets("HL").Cells(i, "B")

  If fechatr <= Worksheets("HL").Cells(i, "A") And fechatr <= Worksheets("HL").Cells(i, "B") Then
    semanastr = Worksheets("HL").Cells(i - 1, "E")
    Exit For
  End If

Next 'fin i = 25 To filafinal


If semanastr >= 750 Then
    regimentr = True
    Exit Sub
Else


    For i = filainicial To filafinal

'SI ES REGIMEN DE TRANSICIÓN ACTO LEGISLATIVO 1
    If fechatr2 >= Worksheets("HL").Cells(i, "A") And fechatr2 <= Worksheets("HL").Cells(i, "B") Then

        If fechatr2 = Worksheets("HL").Cells(i, "B") Then
            semanastr2 = Worksheets("HL").Cells(i, "E")
            Exit For
        End If

        If fechatr2 = Worksheets("HL").Cells(i, "A") Then
            semanastr2 = Worksheets("HL").Cells(i - 1, "E")
            semanastr2 = semanastr2 + (1 / 7)
            Exit For
        End If

        If fechatr2 > Worksheets("HL").Cells(i, "A") And fechatr2 < Worksheets("HL").Cells(i, "B") Then
            semanastr2 = Worksheets("HL").Cells(i - 1, "E")
            semanastr2 = semanastr2 + (fechatr2 - Worksheets("HL").Cells(i, "A")) / 7
            Exit For
        End If

    End If 'fin if fechatr2 >= Worksheets("HL").Cells(i, "A") Or fechatr2 <= Worksheets("HL").Cells(i, "B")

    If fechatr2 <= Worksheets("HL").Cells(i, "A") And fechatr2 <= Worksheets("HL").Cells(i, "B") Then
        semanastr2 = Worksheets("HL").Cells(i - 1, "E")
        Exit For
    End If
Next ' fin i = 25 To filafinal

End If ' fin if semanastr >= 750

If semanastr2 >= 750 Then
    regimentr = True
    Exit Sub
End If 'fin if semanastr >= 750
End Sub
Public Sub PRIVADO()
 'APORTES HECHOS POR FUNCIONARIOS PRIVADOS

    If totalsemanas >= 1250 Then
        tipocalculo = 1 ' TODA LA VIDA Y 10 AÑOS
        Call TODALAVIDA
        Call DIEZAÑOS
        valorpensiontv = promedioibltv * 0.9
        valorpension10 = promedioibl10 * 0.9

        If valorpensiontv >= valorpension10 Then
            valorfinalpension = valorpensiontv
            regimenaplicado = "Decreto 758 de 1990 - IBL Toda la Vida"
        Else
            valorfinalpension = valorpension10
            regimenaplicado = "Decreto 758 de 1990 - IBL 10 años >= 1250 semanas"
        End If

    Else
        tipocalculo = 2 ' ÚLTIMOS 10 AÑOS
        Call DIEZAÑOS
        Call MONTOPENSION10
        regimenaplicado = "Decreto 758 de 1990 - IBL 10 años"
    End If

   Call LEY797
   If regimentr = False Then
    regimenaplicado = "Ley 797 de 2003"
   End If
End Sub

Public Sub LIQUIDACION()
'DE ACUERDO AL TIPO DE APORTE 1 PRIVADO 2 PÚBLICO 3 APORTES, _
 INDICADO EN LA HOJA "HL", CELDA "B19" EJECUTA EL PROCEDIMIENTO INDICADO

   totalsemanas = Worksheets("HL").Cells(filafinal, "E")

   Select Case Worksheets("HL").Range("B19").Value
        Case 1
            codigoregimen = 1
            Call PRIVADO
        Case 2
            codigoregimen = 2
            Call PUBLICO
        Case 3
            codigoregimen = 3
            Call APORTES
    End Select


End Sub
Public Sub TODALAVIDA()
'SI EL TIPO DE APORTE ES PRIVADO EJECUTA ESTE PROCEDIMIENTO PARA DETERMINARL EL PROMEDIO DEL IBL
'DE LOS DIEZ ÚLTIMOS AÑOS

     For l = filainicial To filafinal
        diastv = diastv + Worksheets("HL").Cells(l, "D")
        totalibltv = totalibltv + Worksheets("HL").Cells(l, "I")
    Next
    promedioibltv = totalibltv / diastv
End Sub
Public Sub DIEZAÑOS()
'SI EL TIPO DE APORTE ES PRIVADO EJECUTA ESTE PROCEDIMIENTO PARA DETERMINARL EL PROMEDIO DEL IBL
'DE LOS DIEZ ÚLTIMOS AÑOS


    For l = filafinal To filainicial Step -1
        Worksheets("HL").Cells(l, "J") = Worksheets("HL").Cells(l, "D")
        Worksheets("HL").Cells(l, "K") = Worksheets("HL").Cells(l, "I")
        totalibl10 = totalibl10 + Worksheets("HL").Cells(l, "I")
        diasdiezaños = diasdiezaños + Worksheets("HL").Cells(l, "D")
        If diasdiezaños = 3650 Then
            totalibl10 = (totalibl10 / diasdiezaños)
            Exit For
        End If

        If diasdiezaños > 3650 Then
            diasdiferencia = diasdiezaños - 3650
            Worksheets("HL").Cells(l, "J") = Worksheets("HL").Cells(l, "D") - diasdiferencia
            diasdiezaños = diasdiezaños - Worksheets("HL").Cells(l, "D") + Worksheets("HL").Cells(l, "J")
            If diasdiezaños <> 3650 Then
                msg = MsgBox("TOTAL DIAS <> 3650", vbCritical, "Dirección de Ahorro Individual y Prima Media")
            End If
            Worksheets("HL").Cells(l, "K") = Worksheets("HL").Cells(l, "H") * Worksheets("HL").Cells(l, "J")
            totalibl10 = totalibl10 - Worksheets("HL").Cells(l, "I") + Worksheets("HL").Cells(l, "K")
            Exit For
        End If
    Next
    promedioibl10 = totalibl10 / diasdiezaños
End Sub
Public Sub CALCULOS()
    For J = filainicial To filafinal
        With Worksheets("HL")
            'AÑO FECHA FINAL DEL PERÍODO PARA DETERMINAR EL IPC PARA ACTUALIZACIÓN SALARIO
            .Cells(J, "C") = Year(.Cells(J, "B"))

            'No DE DIAS DEL PERRÍODO
            .Cells(J, "D") = (.Cells(J, "B") - .Cells(J, "A")) + 1

            'No DE SEMANAS ACUMULADAS
            If J = filainicial Then
                .Cells(J, "E") = .Cells(J, "D") / 7
            Else
                .Cells(J, "E") = .Cells(J - 1, "E") + (.Cells(J, "D") / 7)
            End If

            'IPC DE CADA AÑO
            .Cells(J, "G") = BUSCAIPC(.Cells(J, "C"))

            'ACTUALIZA IBC
            .Cells(J, "H") = .Cells(J, "F") * .Cells(J, "G")

            'DETERMINA IBL PARA PERIODO
            .Cells(J, "I") = .Cells(J, "H") * .Cells(J, "D")


        End With

    Next 'fin for i = 25 To filafinal

End Sub

Public Sub PUBLICO()
    Call DIEZAÑOS
    Call ULTIMOAÑO
End Sub

Public Sub APORTES()
    Call DIEZAÑOS
    porcentajepension = 0.75
    valorfinalpensionaportes = promedioibl10 * porcentajepension
    valorfinalpension = valorfinalpensionaportes
End Sub

Public Function BUSCAIPC(año As Integer, Optional factor As Variant)
    For k = 2 To 100
        If Worksheets("TABLA_IPC").Cells(k, "A") = año Then
            BUSCAIPC = Worksheets("TABLA_IPC").Cells(k, "B")
            Exit Function
        End If
    Next

End Function

Public Sub MONTOPENSION10()
    With Worksheets("TABLAS")
        valorpension10 = 0
        porcentajepension = 0
        For Z = 4 To 9
            If totalsemanas >= .Cells(Z, "G") And totalsemanas <= .Cells(Z, "H") Then
                porcentajepension = .Cells(Z, "I")
                Exit For
            End If
        Next
        If porcentajepension = 0 Then
            msg = MsgBox("PORCENTAJE DE PENSIÓN NO HALLADO", vbCritical, "Dirección de Ahorro Individual y Prima Media")
        End If
    End With

    valorfinalpension = promedioibl10 * porcentajepension
End Sub

Public Sub LEY797()
Dim rangoinicial, rangofinal, rangofactor As String
Dim numerofila As Integer

With Worksheets("LEY 797")
        Select Case Year(fechaliquidacion)
    Case 2004
        rangoinicial = "B"
        rangofinal = "C"
        rangofactor = "D"
        'rangomayor = 1400
        numerofila = 24
    Case 2005
        rangoinicial = "E"
        rangofinal = "F"
        rangofactor = "G"
        'rangomayor = 1550
        numerofila = 26
    Case 2006
        rangoinicial = "H"
        rangofinal = "I"
        rangofactor = "J"
        rangomayor = 1575
        numerofila = 26
    Case 2007
        rangoinicial = "K"
        rangofinal = "L"
        rangofactor = "M"
        'rangomayor = 1600
        numerofila = 26
    Case 2008
        rangoinicial = "N"
        rangofinal = "O"
        rangofactor = "P"
        'rangomayor = 1625
        numerofila = 26
    Case 2009
        rangoinicial = "Q"
        rangofinal = "R"
        rangofactor = "S"
        'rangomayor = 1650
        numerofila = 26
    Case 2010
        rangoinicial = "T"
        rangofinal = "U"
        rangofactor = "V"
        'rangomayor = 1675
        numerofila = 26
    Case 2011
        rangoinicial = "W"
        rangofinal = "X"
        rangofactor = "Y"
        'rangomayor = 1700
        numerofila = 26
    Case 2012
        rangoinicial = "Z"
        rangofinal = "AA"
        rangofactor = "AB"
        'rangomayor = 1725
        numerofila = 26
    Case 2013
        rangoinicial = "AC"
        rangofinal = "AD"
        rangofactor = "AE"
        'rangomayor = 1750
        numerofila = 26
    Case 2014
        rangoinicial = "AF"
        rangofinal = "AG"
        rangofactor = "AH"
        'rangomayor = 1775
        numerofila = 26
    Case Is >= 2015
        rangoinicial = "AI"
        rangofinal = "AJ"
        rangofactor = "AK"
        'rangomayor = 1800
        numerofila = 26
End Select

For n = 16 To numerofila
    If totalsemanas >= .Cells(n, rangoinicial) And totalsemanas <= .Cells(n, rangofinal) Then
        porcentajel797 = .Cells(n, rangofactor)
    End If
Next

If porcentajel797 = 0 Then

Exit Sub

End If
End With

'BUSCA EL SALARIO MÍNIMO DE ACUERDO AL AÑO DE LIQUIDACIÓN

With Worksheets("TABLAS")
    For v = 4 To 100
        If Year(fechaliquidacion) = .Cells(v, "K") Then
            numerosmmlv = promedioibl10 / .Cells(v, "L")
            Exit For
        End If
    Next
End With
porcentajel797 = porcentajel797 * 100
factorpensionl797 = porcentajel797 - (0.5 * numerosmmlv)
valorfinalpensionl797 = (promedioibl10 * factorpensionl797) / 100
End Sub
Public Sub ULTIMOAÑO()
    'SI EL TIPO DE APORTE ES PRIVADO EJECUTA ESTE PROCEDIMIENTO PARA DETERMINARL EL PROMEDIO DEL IBL
    'DEL  ÚLTIMO AÑO

    diasdiferencia = 0
    For l = filafinal To filainicial Step -1
        Worksheets("HL").Cells(l, "L") = Worksheets("HL").Cells(l, "D")
        Worksheets("HL").Cells(l, "M") = Worksheets("HL").Cells(l, "I")
        totalibl1año = totalibl1año + Worksheets("HL").Cells(l, "I")
        diasunaño = diasunaño + Worksheets("HL").Cells(l, "D")
        If diasunaño = 365 Then
            totalibl1año = (totalibl1año / diasunaño)
            Exit For
        End If

        If diasunaño > 365 Then
            diasdiferencia = diasunaño - 365
            Worksheets("HL").Cells(l, "L") = Worksheets("HL").Cells(l, "D") - diasdiferencia
            diasunaño = diasunaño - Worksheets("HL").Cells(l, "D") + Worksheets("HL").Cells(l, "L")
            If diasunaño <> 365 Then
                msg = MsgBox("TOTAL DIAS <> 360", vbCritical, "Dirección de Ahorro Individual y Prima Media")
            End If
            Worksheets("HL").Cells(l, "M") = Worksheets("HL").Cells(l, "H") * Worksheets("HL").Cells(l, "L")
            totalibl1año = totalibl1año - Worksheets("HL").Cells(l, "I") + Worksheets("HL").Cells(l, "M")
            Exit For
        End If
    Next
    promedioibl1año = totalibl1año / diasunaño
    valorfinalpensionpub = promedioibl1año * 0.75
End Sub
Public Sub RESUMEN()

     With Worksheets("RESUMEN")
        'NOMBRE
       .Cells(7, "B") = Worksheets("HL").Cells(12, "B")

        'No CC
        .Cells(8, "B") = Worksheets("HL").Cells(12, "D")

        If genero = "1" Then
            .Cells(8, "E") = "FEMENINO"
            .Cells(30, "C") = DateAdd("yyyy", 55, Worksheets("HL").Cells(13, "B"))
        End If

        If genero = "2" Then
            .Cells(8, "E") = "MASCULINO"
            .Cells(31, "C") = DateAdd("yyyy", 60, Worksheets("HL").Cells(13, "B"))
        End If

        'REGIMEN APLICADO
        .Cells(9, "B") = regimenaplicado

        'EDAD AL 01-04-1994
        .Cells(14, "C") = Worksheets("HL").Cells(16, "B")

        'TOTAL SEMANAS COTIZADAS
        .Cells(15, "C") = totalsemanas

        'TOTAL SEMANAS AL 01-04-1994
        .Cells(16, "C") = semanastr

         'TOTAL SEMANAS AL 25-07-2005
        .Cells(17, "C") = semanastr2

        'IBL TODA LA VIDA
        .Cells(21, "C") = promedioibltv

        'IBL DIEZ AÑOS
        .Cells(22, "C") = promedioibl10

        'IBL ÚLTIMO AÑO
        .Cells(23, "C") = promedioibl1año

        'MONTO
        .Cells(24, "C") = porcentajepension

        'MONTO
        .Cells(25, "C") = (factorpensionl797) / 100

        'No SALARIOS MÍNIMOS
        .Cells(26, "C") = numerosmmlv

        'Vr PENSIÓN
        .Cells(27, "C") = valorfinalpension

        'Vr PENSIÓN LEY 797
        .Cells(28, "C") = valorfinalpensionl797

        'Vr PENSIÓN T. PÚBLICOS
        .Cells(29, "C") = valorfinalpensionpub

        'Vr PENSIÓN POR APORTES
        .Cells(30, "C") = valorfinalpensionaportes



    End With
    Worksheets("RESUMEN").Activate
    Range("C27").Select
End Sub

Public Sub VALIDACIONES()
'PROCEDIMIENTO QUE REALIZA VALIDACIONES DE INFORMACIÓN DE ORDEN  LÓGICO


For q = filainicial To filafinal
    With Worksheets("HL")
        'SI FECHA INICIAL ES MAYOR QUE FECHA FINAL (EN LA FILA ACTUAL)
        If .Cells(q, "A") > .Cells(q, "A") Then
            mensaje = "Fecha Inicial mayor a Fecha Final" + Chr(13) + _
                        "Fila:  " + Str(q)
            Exit For
        End If

        'SI FECHA INICIAL ES MENOR QUE FECHA FINAL EN LA FILA ANTERIOR
        If .Cells(q, "A") < .Cells(q - 1, "B") Then
            mensaje = "Fecha Inicial menor a Fecha Final fila anterior" + Chr(13) + _
                        "Fila:  " + Str(q)
            Exit For
        End If

        'SI FECHA INICIAL ES MENOR QUE FECHA INICIAL EN LA FILA ANTERIOR
        If .Cells(q, "A") < .Cells(q - 1, "A") Then
            mensaje = "Fecha Inicial menor a Fecha Inicial fila anterior" + Chr(13) + _
                        "Fila:  " + Str(q)
            Exit For
        End If

        'SI FECHA INICIAL ES MENOR QUE FECHA FINAL EN LA FILA ANTERIOR
        If .Cells(q, "A") < .Cells(q - 1, "B") Then
            mensaje = "Fecha Inicial menor a Fecha Final fila anterior" + Chr(13) + _
                        "Fila:  " + Str(q)
            Exit For
        End If

    End With
Next

If mensaje <> "" Then
    resp = MsgBox(mensaje, vbCritical, "Dirección de Ahorro Individual y Prima Media")
    End
End If


End Sub

Public Sub BORRACELDAS()
'PROCEDIMIENTO QUE BORRA LAS CELDAS DE LAS HOJAS "HL" Y RESUMEN ANTES DE REALIZAR UN NUEVO CÁLCULO

Windows("LIQUIDADOR PRIMA MEDIA.xlsm").Activate
    With Sheets("HL").Activate
        Range("C25:E25").Select
        Range(Selection, Selection.End(xlDown)).ClearContents
        Range("G25:M25").Select
        Range(Selection, Selection.End(xlDown)).ClearContents
    End With

    With Sheets("RESUMEN").Activate
        Range("B7:F7").Select
        Selection.ClearContents
        Range("B8:C8").Select
        Selection.ClearContents
        Range("B9:E9").Select
        Selection.ClearContents
        Range("E8:F8").Select
        Selection.ClearContents
        Range("C14:D14").Select
        Selection.ClearContents
        Range("C15:D15").Select
        Selection.ClearContents
        Range("C16:D16").Select
        Selection.ClearContents
        Range("C17:D17").Select
        Selection.ClearContents
        Range("C21:D21").Select
        Selection.ClearContents
        Range("C22:D22").Select
        Selection.ClearContents
        Range("C23:D23").Select
        Selection.ClearContents
        Range("C24:D24").Select
        Selection.ClearContents
        Range("C25:D25").Select
        Selection.ClearContents
        Range("C26:D26").Select
        Selection.ClearContents
        Range("C27:D27").Select
        Selection.ClearContents
        Range("C28:D28").Select
        Selection.ClearContents
        Range("C29:D29").Select
        Selection.ClearContents
        Selection.ClearContents
        Range("C30:D30").Select
        Selection.ClearContents
        Range("C31").Select
    End With

    Sheets("HL").Activate
    Range("C13").Select
End Sub
Public Sub BOORRATODO()
    Windows("LIQUIDADOR PRIMA MEDIA.xlsm").Activate
    With Sheets("HL").Activate
        Range("A25:M25").Select
        Range(Selection, Selection.End(xlDown)).ClearContents
    End With

    With Sheets("RESUMEN").Activate
        Range("B7:F7").Select
        Selection.ClearContents
        Range("B8:C8").Select
        Selection.ClearContents
        Range("B9:E9").Select
        Selection.ClearContents
        Range("E8:F8").Select
        Selection.ClearContents
        Range("C14:D14").Select
        Selection.ClearContents
        Range("C15:D15").Select
        Selection.ClearContents
        Range("C16:D16").Select
        Selection.ClearContents
        Range("C17:D17").Select
        Selection.ClearContents
        Range("C21:D21").Select
        Selection.ClearContents
        Range("C22:D22").Select
        Selection.ClearContents
        Range("C23:D23").Select
        Selection.ClearContents
        Range("C24:D24").Select
        Selection.ClearContents
        Range("C25:D25").Select
        Selection.ClearContents
        Range("C26:D26").Select
        Selection.ClearContents
        Range("C27:D27").Select
        Selection.ClearContents
        Range("C28:D28").Select
        Selection.ClearContents
        Range("C29:D29").Select
        Selection.ClearContents
        Selection.ClearContents
        Range("C30:D30").Select
        Selection.ClearContents
        Range("C31").Select
    End With

    Sheets("HL").Activate
    Range("C13").Select

End Sub
